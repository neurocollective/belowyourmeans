-- new schema

CREATE TABLE budget_user (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	first_name text, 
	last_name text,
	email text,
	hashed_password text,
	create_date timestamp,
	last_modified_date timestamp,
	UNIQUE(email)
);

-- EAV table
CREATE TABLE user_preference_choice (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) NOT NULL,
	choice_key text,
	choice_value text
);

-- starting categories will have `null` user id. 
CREATE TABLE budget_category (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) default null, --nullable
	display_name text NOT NULL,
	description text
);

-- allow users to hide categories from their account
CREATE TABLE hidden_budget_category (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) NOT NULL,
	budget_category int REFERENCES budget_user(id) NOT NULL
);

-- just a way to group `budget_category_limit` entries. This allows user to switch between different budget concepts.
CREATE TABLE budget_concept (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) NOT NULL,
	name text NOT NULL
);

-- exists as monthly limits, but probably create 12 identitcal rows to start
CREATE TABLE budget_category_limit (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	budget_concept_id int REFERENCES budget_concept(id),
	month_id int NOT NULL,
	dollar_allotment int NOT NULL
);

-- this is how you select by month in a timestamp:
-- SELECT * FROM expenditure
-- WHERE EXTRACT(MONTH FROM date_occurred) > 10;

CREATE TABLE expenditure (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) NOT NULL,
	category_id int REFERENCES budget_category(id), --nullable, expenditures start out unassigned to a category
	value decimal NOT NULL, -- 8.99
	description text NOT NULL, -- `Digital Card Purchase - NETFLIX COM LOS GATOS CA` or `CHEWY.COM`
	date_occurred timestamp NOT NULL, -- `11/02/23`
	create_date timestamp default now(),
	modified_date timestamp default now()
);

CREATE TABLE category_labels (
	id int PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
	user_id int REFERENCES budget_user(id) NOT NULL,
	category_id int REFERENCES budget_category(id),
	description text NOT NULL,
	create_date timestamp default now(),
	modified_date timestamp default now()
);
